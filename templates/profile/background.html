{% load static %}
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}{% endblock %}</title>

  <link rel="stylesheet" href="{% static 'css/styles.css' %}">

  <!-- Utilities สำหรับเอฟเฟกต์ -->
  <style>
    .text-glow    { text-shadow:0 0 8px rgba(255,255,255,.55), 0 0 18px rgba(255,255,255,.35); }
    .text-glow-xl { text-shadow:0 0 14px rgba(255,255,255,.80), 0 0 32px rgba(255,255,255,.50); }
    .neon         { box-shadow:0 0 18px rgba(255,255,255,.35), inset 0 0 12px rgba(255,255,255,.08); }
    .neon-ring    { filter: drop-shadow(0 0 12px rgba(255,255,255,.45)); }

    /* glow เฉพาะตัวไอคอน (ไม่เป็นวงกลม) */
    .icon        { fill:rgba(255,255,255,.80); transition:filter .3s, fill .3s; }
    .icon-hover  { filter:none; }
    a:hover .icon-hover { fill:#fff; filter:drop-shadow(0 0 8px rgba(255,255,255,.9)); }

    .no-pointer  { pointer-events:none; }
  </style>
</head>

<body class="min-h-screen bg-black text-white relative overflow-hidden">

  <!-- วิดีโอพื้นหลัง (ใส่ไฟล์ของคุณที่ static/media/bg-space.mp4 หรือเปลี่ยนชื่อได้) -->
  <!-- Video temporarily disabled; using static overlay only to avoid 404 when file missing -->
  <div class="fixed inset-0 bg-black/65 no-pointer"></div>
  <div class="fixed top-4 right-4 z-50">
    {% if display_user %}
      <div class="flex items-center gap-3 rounded-xl bg-white/10 px-4 py-2 backdrop-blur ring-1 ring-white/20">
        {% if display_avatar_url %}
          <img src="{{ display_avatar_url }}" class="h-8 w-8 rounded-full" alt="avatar" />
        {% endif %}
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium">{{ display_user.global_name|default:display_user.username }}</span>
          {% if presence_status %}
            {% with c='bg-gray-400' %}
              {% if presence_status == 'online' %}{% with c='bg-emerald-500' %}{% endwith %}{% endif %}
              {% if presence_status == 'idle' %}{% with c='bg-amber-400' %}{% endwith %}{% endif %}
              {% if presence_status == 'dnd' %}{% with c='bg-rose-500' %}{% endwith %}{% endif %}
              <span title="{{ presence_status }}" class="inline-block h-2.5 w-2.5 rounded-full {{ c }}"></span>
            {% endwith %}
          {% endif %}
        </div>
        {% if session_user %}
          <a href="{% url 'discord_logout' %}" class="rounded-lg bg-indigo-600 px-3 py-1 text-sm font-medium text-white hover:bg-indigo-700">Logout</a>
        {% endif %}
      </div>
      {% if about_me %}
        <div class="mt-2 rounded-xl bg-white/10 px-4 py-2 text-xs text-white/90 backdrop-blur ring-1 ring-white/20 max-w-sm">
          {{ about_me }}
        </div>
      {% endif %}
    {% else %}
      <a href="{% url 'discord_login' %}" class="rounded-xl bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow hover:bg-indigo-700">Login with Discord</a>
    {% endif %}
  </div>

  <!-- หิมะโปรย -->
  <canvas id="snow" class="fixed inset-0 no-pointer" style="opacity:.9"></canvas>

  <!-- Planets Background -->
  <div class="fixed inset-0 overflow-hidden pointer-events-auto" id="planetsContainer" style="z-index: 1;">
    <!-- Earth -->
    <div class="planet-orbit planet-orbit-1">
      <div class="planet planet-earth group cursor-pointer" data-planet="earth">
        <div class="planet-sphere earth-sphere">
          <div class="earth-clouds"></div>
        </div>
        <div class="planet-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <p class="font-bold text-lg">Earth</p>
          <p class="text-sm">Our home planet</p>
        </div>
      </div>
    </div>

    <!-- Moon -->
    <div class="planet-orbit planet-orbit-2">
      <div class="planet planet-moon group cursor-pointer" data-planet="moon">
        <div class="planet-sphere moon-sphere"></div>
        <div class="planet-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <p class="font-bold text-lg">Moon</p>
          <p class="text-sm">Earth's satellite</p>
        </div>
      </div>
    </div>

    <!-- Saturn -->
    <div class="planet-orbit planet-orbit-3">
      <div class="planet planet-saturn group cursor-pointer" data-planet="saturn">
        <div class="planet-sphere saturn-sphere">
          <div class="saturn-rings"></div>
        </div>
        <div class="planet-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <p class="font-bold text-lg">Saturn</p>
          <p class="text-sm">Lord of the rings</p>
        </div>
      </div>
    </div>

    <!-- Mars -->
    <div class="planet-orbit planet-orbit-4">
      <div class="planet planet-mars group cursor-pointer" data-planet="mars">
        <div class="planet-sphere mars-sphere"></div>
        <div class="planet-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <p class="font-bold text-lg">Mars</p>
          <p class="text-sm">The red planet</p>
        </div>
      </div>
    </div>

    <!-- Venus -->
    <div class="planet-orbit planet-orbit-5">
      <div class="planet planet-venus group cursor-pointer" data-planet="venus">
        <div class="planet-sphere venus-sphere"></div>
        <div class="planet-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <p class="font-bold text-lg">Venus</p>
          <p class="text-sm">Morning star</p>
        </div>
      </div>
    </div>

    <!-- Jupiter -->
    <div class="planet-orbit planet-orbit-6">
      <div class="planet planet-jupiter group cursor-pointer" data-planet="jupiter">
        <div class="planet-sphere jupiter-sphere">
          <div class="jupiter-bands"></div>
        </div>
        <div class="planet-tooltip opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <p class="font-bold text-lg">Jupiter</p>
          <p class="text-sm">Gas giant</p>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Planets styling */
    .planet-orbit {
      position: absolute;
      animation: orbit linear infinite;
      pointer-events: none;
    }

    .planet {
      position: relative;
      pointer-events: auto;
      transition: all 0.3s ease;
    }

    .planet:hover {
      transform: scale(1.2);
    }

    .planet:active {
      transform: scale(1.4) rotate(360deg);
    }

    .planet-sphere {
      border-radius: 50%;
      position: relative;
      box-shadow: inset -10px -10px 40px rgba(0,0,0,0.5),
                  0 0 20px rgba(255,255,255,0.2);
      transition: all 0.3s ease;
    }

    .planet:hover .planet-sphere {
      box-shadow: inset -10px -10px 40px rgba(0,0,0,0.3),
                  0 0 40px currentColor;
    }

    /* Earth */
    .earth-sphere {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle at 30% 30%, #4a9eff, #1e5a9e 40%, #0d2d4d 70%);
      animation: rotate-planet 20s linear infinite;
    }

    .earth-clouds {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="30" r="15" fill="rgba(255,255,255,0.3)"/><circle cx="60" cy="50" r="20" fill="rgba(255,255,255,0.2)"/><circle cx="80" cy="70" r="12" fill="rgba(255,255,255,0.25)"/></svg>');
      opacity: 0.6;
      animation: rotate-clouds 30s linear infinite;
    }

    /* Jupiter */
    .jupiter-sphere {
      width: 75px;
      height: 75px;
      background: radial-gradient(circle at 30% 30%, #e8d4b0, #c9a875 40%, #8b6f47 70%);
      animation: rotate-planet 15s linear infinite;
    }

    .jupiter-bands {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 8px,
        rgba(139, 111, 71, 0.3) 8px,
        rgba(139, 111, 71, 0.3) 12px
      );
      opacity: 0.7;
    }

    /* Saturn */
    .saturn-sphere {
      width: 65px;
      height: 65px;
      background: radial-gradient(circle at 30% 30%, #f4e7c3, #d4b896 40%, #a88f6b 70%);
      animation: rotate-planet 25s linear infinite;
    }

    .saturn-rings {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotateX(75deg);
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 8px solid transparent;
      border-top-color: rgba(201, 168, 117, 0.6);
      border-bottom-color: rgba(201, 168, 117, 0.4);
      pointer-events: none;
    }

    .saturn-rings::after {
      content: '';
      position: absolute;
      inset: -12px;
      border-radius: 50%;
      border: 4px solid transparent;
      border-top-color: rgba(201, 168, 117, 0.3);
      border-bottom-color: rgba(201, 168, 117, 0.2);
    }

    /* Mars */
    .mars-sphere {
      width: 50px;
      height: 50px;
      background: radial-gradient(circle at 30% 30%, #e57373, #c62828 40%, #8b0000 70%);
      animation: rotate-planet 18s linear infinite;
    }

    /* Venus */
    .venus-sphere {
      width: 70px;
      height: 70px;
      background: radial-gradient(circle at 30% 30%, #fff9e6, #ffd54f 40%, #ffb300 70%);
      animation: rotate-planet 22s linear infinite;
    }

    /* Moon */
    .moon-sphere {
      width: 35px;
      height: 35px;
      background: radial-gradient(circle at 30% 30%, #e8e8e8, #b0b0b0 40%, #7a7a7a 70%);
      position: relative;
      animation: rotate-planet 12s linear infinite;
    }

    .moon-sphere::before {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 50%;
      top: 30%;
      left: 40%;
      box-shadow: 
        15px 5px 0 -2px rgba(0,0,0,0.15),
        5px 15px 0 -3px rgba(0,0,0,0.1);
    }

    @keyframes rotate-planet {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes rotate-clouds {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .planet-tooltip {
      position: absolute;
      top: -80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      border-radius: 16px;
      border: 2px solid rgba(168, 85, 247, 0.5);
      white-space: nowrap;
      z-index: 50;
      pointer-events: none;
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
    }

    .planet-tooltip::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border: 10px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
    }

    /* Planet orbits */
    .planet-orbit-1 {
      top: 8%;
      left: 12%;
      animation-duration: 35s;
    }

    .planet-orbit-2 {
      top: 15%;
      right: 15%;
      animation-duration: 20s;
      animation-direction: reverse;
    }

    .planet-orbit-3 {
      bottom: 20%;
      left: 10%;
      animation-duration: 40s;
    }

    .planet-orbit-4 {
      top: 50%;
      right: 8%;
      animation-duration: 28s;
      animation-direction: reverse;
    }

    .planet-orbit-5 {
      bottom: 12%;
      right: 20%;
      animation-duration: 32s;
    }

    .planet-orbit-6 {
      top: 60%;
      left: 5%;
      animation-duration: 45s;
      animation-direction: reverse;
    }

    @keyframes orbit {
      0% {
        transform: translate(0, 0) rotate(0deg);
      }
      25% {
        transform: translate(40px, -35px) rotate(90deg);
      }
      50% {
        transform: translate(70px, 0) rotate(180deg);
      }
      75% {
        transform: translate(40px, 35px) rotate(270deg);
      }
      100% {
        transform: translate(0, 0) rotate(360deg);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .earth-sphere { width: 50px; height: 50px; }
      .jupiter-sphere { width: 48px; height: 48px; }
      .saturn-sphere { width: 42px; height: 42px; }
      .saturn-rings { width: 75px; height: 75px; border-width: 5px; }
      .mars-sphere { width: 32px; height: 32px; }
      .venus-sphere { width: 45px; height: 45px; }
      .moon-sphere { width: 25px; height: 25px; }
      
      .planet-tooltip {
        font-size: 0.75rem;
        padding: 8px 12px;
        top: -60px;
      }
    }

    @media (min-width: 1024px) {
      .earth-sphere { width: 95px; height: 95px; }
      .jupiter-sphere { width: 90px; height: 90px; }
      .saturn-sphere { width: 78px; height: 78px; }
      .saturn-rings { width: 145px; height: 145px; }
      .mars-sphere { width: 60px; height: 60px; }
      .venus-sphere { width: 85px; height: 85px; }
      .moon-sphere { width: 42px; height: 42px; }
    }
  </style>

  {% block body %}{% endblock %}

  <!-- เพลง -->
  <audio id="bgm" preload="auto" loop>
    <source src="{% static 'media/iwantu.mp3' %}" type="audio/mpeg">
  </audio>
  <button id="musicBtn"
          class="fixed bottom-5 right-5 rounded-full px-4 py-2 text-sm bg-white/5 hover:bg-white/10 border border-white/10 backdrop-blur z-10">
    ⏸ Pause
  </button>

  <script>
    // Force auto-play music - AGGRESSIVE approach
    const audio = document.getElementById('bgm');
    const btn = document.getElementById('musicBtn');
    let isPlaying = false;

    // Set volume
    audio.volume = 0.7;

    // Function to play music
    function playMusic() {
      if (isPlaying) return;
      
      const playPromise = audio.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            isPlaying = true;
            btn.textContent = '⏸ Pause';
            console.log('Music playing');
          })
          .catch(error => {
            isPlaying = false;
            btn.textContent = '▶︎ Play';
            console.log('Autoplay prevented:', error);
          });
      }
    }

    // Try to play immediately
    playMusic();

    // Try again after short delay
    setTimeout(() => playMusic(), 100);
    setTimeout(() => playMusic(), 500);
    setTimeout(() => playMusic(), 1000);

    // Play on ANY user interaction (one-time events)
    const interactions = ['click', 'touchstart', 'touchend', 'mousedown', 'keydown'];
    
    function handleInteraction() {
      playMusic();
      // Remove all listeners after first successful play
      if (isPlaying) {
        interactions.forEach(event => {
          document.removeEventListener(event, handleInteraction);
        });
      }
    }
    
    interactions.forEach(event => {
      document.addEventListener(event, handleInteraction, { once: false });
    });

    // Ensure loop is working
    audio.addEventListener('ended', () => {
      console.log('Track ended, looping...');
      audio.currentTime = 0;
      playMusic();
    });

    // Toggle button
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      
      if (!isPlaying || audio.paused) {
        playMusic();
      } else {
        audio.pause();
        isPlaying = false;
        btn.textContent = '▶︎ Play';
      }
    });

    // Handle visibility change (when user returns to tab)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && isPlaying && audio.paused) {
        playMusic();
      }
    });

    // snow effect
    (function (){
      const c = document.getElementById('snow');
      if (!c) return;
      const ctx = c.getContext('2d');
      let w, h, flakes=[];
      const R = () => Math.random();
      function resize(){ w= c.width = innerWidth; h = c.height = innerHeight; }
      addEventListener('resize', resize); resize();
      function spawn(n=160){
        flakes = Array.from({length:n}, ()=>({
          x:R()*w, y:R()*h, r:1+R()*2.2, s:.5+R()*1.2, a:.3+.7*R(), drift:(R()-.5)*0.6
        }));
      }
      spawn();
      let t=0;
      function tick(){
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        for (const f of flakes){
          f.y += f.s; f.x += Math.sin((t+f.y)*0.003)*0.3 + f.drift;
          if (f.y > h+4) { f.y = -4; f.x = R()*w; }
          ctx.globalAlpha = f.a;
          ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        t++; requestAnimationFrame(tick);
      }
      if (!matchMedia('(prefers-reduced-motion: reduce)').matches) tick();
    })();

    // Planet click effects
    document.addEventListener('DOMContentLoaded', function() {
      const planets = document.querySelectorAll('.planet');
      
      planets.forEach(planet => {
        planet.addEventListener('click', function(e) {
          e.stopPropagation();
          
          // Show message
          const message = this.querySelector('.planet-message');
          message.classList.add('show');
          setTimeout(() => message.classList.remove('show'), 3000);
          
          // Create explosion effect
          const explosion = document.createElement('div');
          explosion.style.cssText = `
            position: absolute;
            inset: -50%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8), transparent 70%);
            animation: explode 0.6s ease-out forwards;
            pointer-events: none;
            z-index: 10;
          `;
          this.appendChild(explosion);
          setTimeout(() => explosion.remove(), 600);
          
          // Create particle burst
          for (let i = 0; i < 12; i++) {
            const particle = document.createElement('div');
            const angle = (Math.PI * 2 * i) / 12;
            const velocity = 80 + Math.random() * 40;
            
            particle.style.cssText = `
              position: absolute;
              left: 50%;
              top: 50%;
              width: 8px;
              height: 8px;
              background: white;
              border-radius: 50%;
              box-shadow: 0 0 10px rgba(255,255,255,0.8);
              pointer-events: none;
              z-index: 10;
            `;
            
            particle.style.animation = `particle-fly 1s ease-out forwards`;
            particle.style.setProperty('--angle', angle + 'rad');
            particle.style.setProperty('--velocity', velocity + 'px');
            
            this.appendChild(particle);
            setTimeout(() => particle.remove(), 1000);
          }
          
          // Screen flash
          const flash = document.createElement('div');
          flash.style.cssText = `
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at ${e.clientX}px ${e.clientY}px, rgba(255,255,255,0.4), transparent 50%);
            pointer-events: none;
            z-index: 9999;
            animation: flash-out 0.5s ease-out forwards;
          `;
          document.body.appendChild(flash);
          setTimeout(() => flash.remove(), 500);
        });
      });
    });

    // Additional animations
    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
      @keyframes explode {
        0% {
          transform: scale(0);
          opacity: 1;
        }
        100% {
          transform: scale(3);
          opacity: 0;
        }
      }
      
      @keyframes particle-fly {
        0% {
          transform: translate(-50%, -50%) rotate(var(--angle)) translateY(0);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) rotate(var(--angle)) translateY(calc(-1 * var(--velocity)));
          opacity: 0;
        }
      }
      
      @keyframes flash-out {
        0% { opacity: 1; }
        100% { opacity: 0; }
      }
    `;
    document.head.appendChild(styleSheet);
  </script>
</body>
</html>
