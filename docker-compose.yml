services:
  web:
    build: .
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - DEBUG=${DEBUG:-1}
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
      - DISCORD_REDIRECT_URI=${DISCORD_REDIRECT_URI:-http://localhost:8000/auth/discord/callback/}
      - DISCORD_SCOPE=${DISCORD_SCOPE:-identify}
      - DISCORD_OWNER_ID=${DISCORD_OWNER_ID}
      - DISCORD_WIDGET_GUILD_ID=${DISCORD_WIDGET_GUILD_ID}
      - DISCORD_OWNER_ABOUT=${DISCORD_OWNER_ABOUT}
  tailwind:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm ci || npm install && npm run dev"
    volumes:
      - .:/app
    # Ensure the dev watcher writes compiled CSS to static/css
  bot:
    image: doger-web:latest
    working_dir: /app
    command: sh -c "pip install -q --no-cache-dir discord.py && python bot/main.py"
    env_file:
      - .env
    environment:
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - DISCORD_PRESENCE_USER_ID=${DISCORD_PRESENCE_USER_ID:-${DISCORD_OWNER_ID}}
      - DISCORD_PRESENCE_FILE=${DISCORD_PRESENCE_FILE:-runtime/presence.json}
      - DISCORD_WIDGET_GUILD_ID=${DISCORD_WIDGET_GUILD_ID}
    volumes:
      - .:/app
